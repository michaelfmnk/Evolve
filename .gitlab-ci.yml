variables:
  DOCKER_DRIVER: overlay2

variables:
  DOCKER_IMAGE: registry.gitlab.com/dnu-dreamteam/dolgov/api:latest

services:
- docker:dind

stages:
- build-api
- deploy

build-api:
  image: docker:latest
  stage: build-api
  before_script:
  - cd ./api/
  script:
  - >
    docker run -t --rm
    -v /var/run/docker.sock:/var/run/docker.sock
    -v "$(pwd)":"$(pwd)"
    -w "$(pwd)"
    -u 0:0
    maven:3-jdk-8
    mvn clean package -Pdocker
  after_script:
  - cd /
  artifacts:
    paths:
    - ./api/target/api-0.0.1-SNAPSHOT.jar
    when: always

deploy:
  stage: deploy
  before_script:
  - apt-get update -y && apt-get install sshpass
  script:
  - docker push $DOCKER_IMAGE
  - sshpass -p "${DEPLOYMENT_SERVER_PASSWORD}" scp -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no ./environment.env ${DEPLOYMENT_SERVER_USER}@${DEPLOYMENT_SERVER_IP}:~/
  - sshpass -p "${DEPLOYMENT_SERVER_PASSWORD}" scp -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no ./infrastructure/docker-compose-dev.yml ${DEPLOYMENT_SERVER_USER}@${DEPLOYMENT_SERVER_IP}:~/
  - sshpass -p $DEPLOYMENT_SERVER_PASS ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no $DEPLOYMENT_SERVER_USER@$DEPLOYMENT_SERVER_IP "echo ${$DEPLOYMENT_SERVER_PASSWORD} | sudo -S ls && docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}; sudo docker-compose -f docker-compose-dev.yml stop; sudo docker-compose -f docker-compose-dev.yml rm web --force; sudo docker pull ${CI_REGISTRY}/${CI_API}:latest; sudo docker-compose -f docker-compose-dev.yml up -d"
#  only:
#  - master
