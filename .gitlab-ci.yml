variables:
  DOCKER_DRIVER: overlay2
  DOCKER_IMAGE_API: registry.gitlab.com/dnu-dreamteam/dolgov/api:latest

services:
- docker:dind

stages:
- build-api
- pushing-containers

build-api:
  image: docker:latest
  stage: build-api
  before_script:
  - cd ./api/
  script:
  - >
    docker run -t --rm
    -v /var/run/docker.sock:/var/run/docker.sock
    -v "$(pwd)":"$(pwd)"
    -w "$(pwd)"
    -u 0:0
    maven:3-jdk-8
    mvn clean package -Pdocker
  after_script:
  - cd /
  artifacts:
    paths:
    - ./api/target/api-0.0.1-SNAPSHOT.jar
    when: always


pushing-containers:
  stage: pushing-containers
  image: docker:latest
  before_script:
  - docker login registry.example.com -u ${CI_DEPLOY_USER} -p ${CI_DEPLOY_PASSWORD}
  script:
  - docker push $DOCKER_IMAGE_API
  after_script:
  - docker logout


#deploy:
#  stage: deploy
#  image: docker:latest
#  before_script:
#  - apt-get update -y && apt-get install sshpass
#  - docker login registry.example.com -u ${CI_DEPLOY_USER} -p ${CI_DEPLOY_PASSWORD}
#  script:
#  - docker push $DOCKER_IMAGE_API
#  after_script:
#  - docker logout
#  only:
#  - master
